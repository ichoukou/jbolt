var menu=$("#menu");var menuPortal=$("#menuPortal");var level1Box=$("#level1Box");function changeTitle(a,b){switch(b){case"none":$("#menuTitle").text("菜单值");$("#menuBox").hide();$("#menuValue").val("");$("#menuValue").data("rule","");$("#appIdBox").hide();$("#pagepathBox").hide();$("#appId").hide().val("");$("#appId").data("rule","");$("#pagepath").hide().val("");$("#pagepath").data("rule","");break;case"view":$("#menuTitle").text("URL");$("#menuBox").show();$("#menuValue").data("rule","required");$("#appIdBox").hide();$("#pagepathBox").hide();$("#appId").hide().val("");$("#appId").data("rule","");$("#pagepath").hide().val("");$("#pagepath").data("rule","");break;case"keywords":$("#menuTitle").text("关键词");$("#menuBox").show();$("#menuValue").data("rule","required");$("#appIdBox").hide();$("#pagepathBox").hide();$("#appId").hide().val("");$("#appId").data("rule","");$("#pagepath").hide().val("");$("#pagepath").data("rule","");break;case"click":$("#menuTitle").text("事件KEY");$("#menuBox").show();$("#menuValue").data("rule","required");$("#appIdBox").hide();$("#pagepathBox").hide();$("#appId").hide().val("");$("#appId").data("rule","");$("#pagepath").hide().val("");$("#pagepath").data("rule","");break;case"miniprogram":$("#menuTitle").text("默认URL");$("#menuBox").show();$("#menuValue").data("rule","required");$("#appIdBox").show();$("#pagepathBox").show();$("#appId").show().data("rule","required");$("#pagepath").show().data("rule","required");break;default:$("#menuTitle").text("事件KEY");$("#menuBox").show();$("#menuValue").data("rule","required");$("#appIdBox").hide();$("#pagepathBox").hide();$("#appId").hide().val("");$("#appId").data("rule","");$("#pagepath").hide().val("");$("#pagepath").data("rule","");break}}function insertLevel1Blank(b){for(var a=1;a<=b;a++){level1Box.append('<li data-id="0" data-pid="0"><span><i class="fa fa-plus"></i></span></li>')}}function insertLevel1Menus(b){for(var a in b){level1Box.append('<li data-id="'+b[a].id+'" data-pid="'+b[a].pid+'"><ul class="level2"></ul><span>'+b[a].name+'</span><i class="fa fa-remove text-danger"></i></li>')}}function insertPlusBtn(b,a){b.append('<li data-id="0" data-pid="'+a+'"><i class="fa fa-plus"></i></li>')}function insertLevel2Menus(b,c){for(var a in c){b.append('<li data-id="'+c[a].id+'" data-pid="'+c[a].pid+'"><span>'+c[a].name+'</span><i class="fa fa-remove text-danger"></i></li>')}}function readLevel2MenusByPid(b,a,c){b.empty();Ajax.get("/admin/wechat/menu/level2List/"+mpId+"-"+a,function(e){var f=e.data;if(f&&f.length>0){insertLevel2Menus(b,f);var d=5-f.length;if(d>0){insertPlusBtn(b,a)}}else{insertPlusBtn(b,a)}if(c){c()}})}function readLevel2Menus(){$(".level1>li").each(function(){var a=$(this);var c=a.data("id");var b=a.find("ul");readLevel2MenusByPid(b,c,function(){})})}function readLevel1Menus(a){level1Box.empty();Ajax.get("/admin/wechat/menu/level1List/"+mpId,function(c){var d=c.data;if(d&&d.length>0){insertLevel1Menus(d);var b=3-d.length;if(b>0){insertLevel1Blank(b)}if(a){a()}}else{insertLevel1Blank(3)}})}function createNewMenu(d,a,b,c){LayerMsgBox.loading("执行中...",3000);Ajax.post("/admin/wechat/menu/save",{"mpId":mpId,"menu.pid":a},function(f){var g=f.data;if(d==2){b.before('<li class="active" data-id="'+g.id+'" data-pid="'+g.pid+'"><span>'+g.name+'</span><i class="fa fa-remove text-danger"></i></li>');if(g.sortRank==5){b.remove()}}else{if(d==1){b.addClass("active");b.data("id",g.id);b.data("pid",g.pid);b.html('<ul class="level2"></ul><span>'+g.name+'</span><i class="fa fa-remove text-danger"></i>');var e=b.find("ul");insertPlusBtn(e,g.id)}}if(c){c(f.data.id)}})}function changeFormPortal(b){LayerMsgBox.loading("请稍等...",500);var a="/admin/wechat/menu/edit/"+mpId+"-"+(b?b:0);menuPortal.ajaxPortal(true,a,true)}function refreshAllDatas(){var a=$("ul.level1>li.active");var b=0;if(a&&a.length>0){b=a.data("id")}readLevel1Menus(function(){if(b){$("ul.level1>li[data-id='"+b+"']").addClass("active")}readLevel2Menus()})}function delMenuProcess(c){var a=$(".menus ul>li.active");if(a&&a.length>0){var b=a.data("id");if(b==c){menuPortal.empty()}}}function delMenu(b,c,a){LayerMsgBox.confirm("确定删除此菜单？",function(){LayerMsgBox.loading("执行中...",3000);Ajax.get("/admin/wechat/menu/delete/"+mpId+"-"+c,function(d){LayerMsgBox.success("删除成功",100,function(){delMenuProcess(c);if(a==0){refreshAllDatas();b.data("id",0);b.html('<span><i class="fa fa-plus"></i></span>')}else{var e=b.parent();b.remove();var f=e.find("li[data-id='0']");if(!f||(f&&f.length==0)){insertPlusBtn(e,a)}}})})})}function changeMenu(d){var a=$("li[data-id='"+d.id+"']");var c=a.parent();var b=d.pid;readLevel2MenusByPid(c,b,function(){var e=$("li[data-id='"+d.id+"']");e.addClass("active")})}function submitModifyForm(){var a=$("#menuEditForm");if(FormChecker.check(a)){LayerMsgBox.loading("执行中...",3000);var b=$("#menuEditForm").serialize();Ajax.post("/admin/wechat/menu/update",b,function(c){LayerMsgBox.success("操作成功",500,function(){var d=c.data;if(d.pid>0){changeMenu(d)}else{refreshAllDatas()}})})}}function publishToWeixin(){LayerMsgBox.confirm("确认发布到公众号?",function(){LayerMsgBox.loading("发布中...",10000);
Ajax.get("/admin/wechat/menu/publish/"+mpId,function(){LayerMsgBox.success("发布成功,请到公众号里查看效果",2000)})})}function initMenuEvent(){$(".menus").on("click","ul.level1>li",function(c){c.preventDefault();c.stopPropagation();$("ul.level1>li.active,ul.level2>li.active").removeClass("active");var b=$(this);var d=b.data("id");var a=b.data("pid");if(d>0){b.addClass("active");changeFormPortal(d)}else{createNewMenu(1,a,b,function(e){changeFormPortal(e)})}});$(".menus").on("click","ul.level2>li",function(c){c.preventDefault();c.stopPropagation();$("ul.level1>li.active,ul.level2>li.active").removeClass("active");var b=$(this);var d=b.data("id");var a=b.data("pid");if(d>0){b.addClass("active");changeFormPortal(d)}else{createNewMenu(2,a,b,function(e){changeFormPortal(e)})}});$(".menus").on("click","i.fa-remove",function(d){d.preventDefault();d.stopPropagation();var c=$(this);var a=c.parent();var f=a.data("id");var b=a.data("pid");delMenu(a,f,b)})}$(function(){initMenuEvent();readLevel1Menus(function(){readLevel2Menus()})});